---
import type { AdminLayoutProps } from '@/types'
import AdminLayout from '@/layouts/AdminLayout.astro'
import { themeConfig } from '@/config/default'

interface Props extends AdminLayoutProps {
  post: CollectionEntry<'posts'>
}

const { post } = Astro.props
const { id } = Astro.params

---

<AdminLayout
  config={themeConfig}
  title={`Edit Post: ${post.data.title}`}
  description={`Edit post ${post.data.title}`}
>
  <div class="container mx-auto px-4 py-8 space-y-8">
    <h1 class="text-3xl font-bold">Edit Post: {post.data.title}</h1>
    
    <form
      id="edit-form"
      class="space-y-6"
      method="POST"
      action={`/api/posts/${id}`}
    >
      <div>
        <label class="block text-sm font-medium text-gray-700">Title</label>
        <input
          type="text"
          name="title"
          value={post.data.title}
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Description</label>
        <textarea
          name="description"
          rows="3"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        >
          {post.data.description}
        </textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Content</label>
        <textarea
          name="content"
          rows="20"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 font-mono"
        >
          {post.body}
        </textarea>
      </div>

      <div>
        <label class="block text-sm font-medium">
          <input
            type="checkbox"
            name="draft"
            class="mr-2"
            checked={post.data.draft}
          />
          Draft
        </label>
      </div>

      <div class="flex justify-end space-x-4">
        <button
          type="button"
          class="inline-flex justify-center rounded-md border border-transparent bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
          onclick={`window.location.href='/admin/posts'`}
        >
          Cancel
        </button>
        <button
          type="submit"
          class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          Save
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
document.getElementById('edit-form')?.addEventListener('submit', async (e) => {
  e.preventDefault()
  const form = e.target as HTMLFormElement
  const formData = new FormData(form)
  
  try {
    const response = await fetch(form.action, {
      method: 'PUT',
      body: JSON.stringify(Object.fromEntries(formData)),
      headers: {
        'Content-Type': 'application/json',
      },
    })
    
    if (response.ok) {
      window.location.href = '/admin/posts'
    } else {
      alert('Failed to update post')
    }
  } catch (error) {
    console.error('Error:', error)
    alert('Failed to update post')
  }
})
</script>
